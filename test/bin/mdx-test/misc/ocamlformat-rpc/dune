(rule
 (target test-case.actual)
 (deps
  (package mdx)
  (source_tree ocamlformat-rpc))
 (action
  (with-stdout-to
   %{target}
   (setenv
    MDX__OCAMLFORMAT_RPC_CONFIG
    "profile=janestreet"
    (run ocaml-mdx test --output - --format-code %{dep:test-case.md})))))

(rule
 (alias runtest)
 (action
  (diff test-case.expected test-case.actual)))
